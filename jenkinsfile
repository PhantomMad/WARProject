pipeline {
    agent any
    tools {
        terraform 'tf1.2.9'
    }
    stages {
        stage('Copy sec TFiles') {
            steps {
                sh 'cp /home/jenkins/users.txt .'
                sh 'cp /home/jenkins/main.tf .'
                sh 'cp /home/jenkins/.passwd-s3fs .'
                sh 'cp /home/jenkins/users.txt ./prod'
                sh 'cp /home/jenkins/main.tf ./prod'
                sh 'cp /home/jenkins/.terraformrc /var/lib/jenkins'
             }
        }
        stage('Init TF build provider'){
            steps {
                sh 'terraform init'
            }
        }
        stage('Init TF prod provider'){
            dir ("prod") {
                steps {
                    sh 'terraform init'
                }
            }
        }
        stage('Validate TF config'){
            steps {
                sh 'terraform validate'
            }
        }
        stage('Format TF config'){
            steps {
                sh 'terraform fmt'
            }
        }
        stage('Plan TF'){
            steps {
                sh 'terraform plan'
            }
        }
//         stage('Apply TF'){
//             steps {
//                 sh 'echo "yes" | terraform apply'
//             }
//         }
//         stage('GetSet IP '){
//             steps {
//                 script {
//                     def VMEXTIP = sh(script:'terraform output external_ip_address', returnStdout:true)
//                     def HCONFIG = "[WORKER]\n" + VMEXTIP
//                     writeFile(file: 'ansible/hosts.cfg', text: HCONFIG)
//                 }
//                 sh 'sed -e \'s/"//\' -e \'s/"$//\' -i ansible/hosts.cfg'
//
//             }
//         }
//         stage('Apply paybook'){
//            input {
// 		       message "Confirm yandex cloud node succefully run"
// 			   ok "Go!"
// 		   }
// 		   steps {
//               dir("ansible"){
//                   ansiblePlaybook (become: true,
//                                    colorized: true,
//                                    credentialsId: 'Jenkins_slaves',
//                                    disableHostKeyChecking: true,
//                                    installation: 'IaC',
//                                    inventory: 'hosts.cfg',
//                                    playbook: 'wproject.yml')
//               }
//             }
//         }
        stage('Clear TF'){
          steps {
              sh 'find /var/lib/jenkins/workspace/WARProject -mindepth 1 -delete'
          }
        }
    }
}